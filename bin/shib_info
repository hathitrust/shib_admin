#!/usr/bin/env ruby

## Bundler binstub boilerplate
require "pathname"
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile",
  Pathname.new(__FILE__).realpath)

require "rubygems"
require "bundler/setup"
##

require 'optparse'
require_relative '../lib/metadata.rb'

# get args
verbose = false
OptionParser.new do |opts|
  opts.banner = <<usage

Usage: #{$0} [-v] [ entityID_substring ]

Prints a list of possible entityID matches, or additional information on the
entitly if there is exactly one match.

Use without options to see full list of InCommon IdPs.

usage

  opts.on("-v", "Print XML dump of full EntityDescriptor") do |v|
    verbose = v
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end

end.parse!

q = ARGV[0]

eids = get_entityIDs(q)

# no match
if eids.size < 1
  puts "#{q}: no match"
# many matches, list hits
elsif eids.size > 1
  puts eids
# one match, print IdP info
else
  info = get_entity_info(q)

  puts "EntityID: #{info[:entityID]}"
  puts "Name: #{info[:name]}"
  if(info[:support_contacts] and (info[:support_contacts].size > 0))
    puts "Support Contact: #{info[:support_contacts].join(', ')}"
  else
    puts "Support Contact: NO SUPPORT CONTACT"
  end

  if(info[:technical_contacts] and (info[:technical_contacts].size > 0))
    puts "Technical Contact: #{info[:technical_contacts].join(', ')}"
  else
    puts "Technical Contact: NO TECHNICAL CONTACT"
  end

  if verbose
    puts 'EntityDescriptor:'
    puts get_EntityDescriptor(q)
  else
    puts 'SessionInitiator:'
    puts mk_initiator(info[:entityID])
  end
end
